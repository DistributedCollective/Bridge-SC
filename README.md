# Sovryn Token Bridge and Converter

## Scripts
All the script from `sovryn-token-bridge/bridge/scripts` directory use the contract addresses from the build contract directory json files.

1. Allow tokens
2. Configure Bridge fee percentage
3. Add meber to federation
4. Deploy Sovryn test tokes: 
   1. Dai Stablecoin, DAI
   2. Wrapped Ether, WETH
   3. Wrapped BTC, WBTC
   4. RenBTC, renBTC
   5. Tether USD, USDT


## Allow tokens
New tokens must be allowed in the AllowTokens contract which resides in the original token network. As an example, DAI should be allowed in ETH and DOC in RSK.

To allow a token go to directory `sovryn-token-bridge/bridge` and run:
 - `npx truffle exec ./scripts/allowToken.js --network <networkName> <tokenAddress>`


## Deploy

### Deploy Sovryn test tokens
1. Run `npx truffle exec ./scripts/deploySovrynTestTokens.js --network kovan`

### Deploy contracts and configure them
2. Deploy Bridge on RSK and Ethereum. See [Briedge README](./sovryn-token-bridge/bridge/README.md)
3. Deploy Converter contract on RSK. See [Converter README](./token-converter/README.md)
4. From directory Bridge run:
   1. Update percentage value:
      1. `npx truffle exec ./scripts/setFeePercentage.js --network <rskNetwork> <percentageValue>`
      2. `npx truffle exec ./scripts/setFeePercentage.js --network <ethNetwork> <percentageValue>`
   2. Allow tokens on their main network. As an example, DAI should be allowed in ETH and DOC in RSK:
      1. `npx truffle exec ./scripts/allowToken.js --network <networkName> <tokenAddress>`
   3. Add federation nodes' addresses. The address to add is the one correspondig to the privateKey configured in `federator/config/federator.key`:
      1. `npx truffle exec ./scripts/addMemberToFederation.js --network <rskNetwork> <newMemberAddress>`
      2. `npx truffle exec ./scripts/addMemberToFederation.js --network <ethNetwork> <newMemberAddress>`
      3. It is worth noting that the number of allowed members in the Federation contract must be equals to the numbers of nodes running. Otherwise, the transactions will not be approved because it is needed simple majority (half plus one of the votes).
5. Ensure the Federator account has balance on both networks.
6. Copy Bridge configs to `ops/${ENVIRONMENT}/configs directory`, where `ENVIRONMENT` is `staging|uat|production`.
   1. config.js
   2. mainchain JSON file. It was generated by the deploy script in `/federator/config/` directory using the networkName as the file name.
   3. sidechain JSON file. It was generated by the deploy script in `/federator/config/` directory using the networkName as the file name.
   4. federator.key
   5. db directory
   6. log-config.json
7. Change Contract addresses in `ui/index.html`. You can search "CONFIGS" in the file to found the place where they are configured. The RSK addresses must be in lowercase.
8. Copy the above files to server running `./ops.sh --config-server environment`.
9.  Edit `ops/docker/docker-compose-base.yml` file with the pertinent docker images.
10. Push `ops/docker/docker-compose-base.yml` to a release branch.
11. Run deploy pipe from gitlab.
