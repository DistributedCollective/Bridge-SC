# Sovryn Token Bridge and Converter

## Scripts
All the script from `sovryn-token-bridge/bridge/scripts` directory use the contract addresses from the build contract directory json files.

1. Allow tokens
2. Configure Bridge fee percentage
3. Set the minimum token amount allowed crossing
4. Add a member to federation
5. Deploy Sovryn test tokes: 
   1. Dai Stablecoin, DAI
   2. Wrapped Ether, WETH
   3. Wrapped BTC, WBTC
   4. RenBTC, renBTC
   5. Tether USD, USDT


## Allow tokens
New tokens must be allowed in the AllowTokens contract which resides in the original token network. As an example, DAI should be allowed in ETH and DOC in RSK.

To allow a token go to directory `sovryn-token-bridge/bridge` and run:
 - `npx truffle exec ./scripts/allowToken.js --network <networkName> <tokenAddress>`

## How to get the side tokens from the original tokens
- After the first token cross the bridge creates the side token on the side chain. You can use `npx truffle exec --network kovan ./scripts/test/createRskSideTokens.js <cant>` to make a cross of `<cant>` of each token to the same address.
- call `bridge.mappedTokens(original token address)` using the bridge from the side chain.
- As an example, if you want to get the rDAI token address call `mappedTokens` on the rsk network passing as argument the DAI token address.

## Bridge token amounts limitations
The Bridge contracts have a set of rules, for all tokens, that determine how many tokens a user can cross. Those rules are:
- maxTokensAllowed = 10000 ether; Maximum number of tokens allowed crossing.
- minTokensAllowed = 1 ether; Minimum number of tokens allowed crossing.
- dailyLimit = 100000 ether; Limit by day of token allowed crossing.

It is worth noting that the Bridge contract format the amount of token before validating the rules. This format is applied to tokens with a different amount of decimals from 18.

Having said that, the default value (1 ether) prevents user to cross less a fractional amount of tokens.

You can use the script `setMinTokenAmount.js` to set the minimum amount:
  `npx truffle exec ./scripts/setMinTokenAmount.js --network <networkName> amount`

## Deploy

### Deploy Sovryn test tokens
1. Run `npx truffle exec ./scripts/deploySovrynTestTokens.js --network kovan`

### Deploy contracts and configure them
2. Deploy Bridge on RSK and Ethereum. See [Bridge README](./sovryn-token-bridge/bridge/README.md)
3. Deploy Converter contract on RSK. See [Converter README](./token-converter/README.md)
4. From directory Bridge run:
   1. Update percentage value:
      1. `npx truffle exec ./scripts/setFeePercentage.js --network <rskNetwork> <percentageValue>`
      2. `npx truffle exec ./scripts/setFeePercentage.js --network <ethNetwork> <percentageValue>`
   2. Allow tokens on their main network. As an example, DAI should be allowed in ETH and DOC in RSK:
      1. `npx truffle exec ./scripts/allowToken.js --network <networkName> <tokenAddress>`
   3. Add federation nodes' addresses. The address to add is the one corresponding to the privateKey configured in `federator/config/federator.key`:
      1. `npx truffle exec ./scripts/addMemberToFederation.js --network <rskNetwork> <newMemberAddress>`
      2. `npx truffle exec ./scripts/addMemberToFederation.js --network <ethNetwork> <newMemberAddress>`
      3. It is worth noting that the number of allowed members in the Federation contract must be equals to the numbers of nodes running. Otherwise, the transactions will not be approved because it is needed a simple majority (half plus one of the votes).
5. Ensure the Federator account has balance on both networks.
6. Copy Bridge configs to `ops/${ENVIRONMENT}/configs directory`, where `ENVIRONMENT` is `staging|uat|production`.
   1. config.js
   2. mainchain JSON file. It was generated by the deployment script in `/federator/config/` directory using the networkName as the file name.
   3. sidechain JSON file. It was generated by the deployment script in `/federator/config/` directory using the networkName as the file name.
   4. federator.key
   5. db directory
   6. log-config.json
7. Change Contract addresses in `ui/index.html`. You can search "CONFIGS" in the file to found the place where they are configured. The RSK addresses must be in lowercase.
8. Setup server and copy the above files to server running `./ops.sh --config-server environment` from directory `ops`.
9. Edit `ops/docker/docker-compose-base.yml` file with the pertinent docker images.
10. Push `ops/docker/docker-compose-base.yml` to a release branch.
11. Run deploy pipe from gitlab or run manually using `./ops.sh --deploy $environment`

## Common Issues

### `receiveTokensAt` transaction fails.
It might be because:
1. The bridge proxy is pointing to an old bridge implementation. So, the function doesn't exist in the contract.
   1. Try to upgrade the contract using a script similar to the migration `sovryn-token-bridge/bridge/migrations/16_deploy_bridge_v2.js`.
2. See `receiveTokens` problems.

### `receiveTokens` transaction fails.
It might be because:
1. You forgot to make an approval transaction for the bridge address and the pertinent token amount.
2. The token is not allowed in the `AllowTokens` contract configured in the `Bridge`.
3. The `feePercentage` is not configured in the `Bridge`.

### Federation vote transaction fails
It might be because:
1. The mainchain or sidechain configs are wrong.
2. The federation contract has set a wrong bridge address. 
   1. Use `federation.setBridge` function. This can be executed only by the owner which is the MultiSigWallet.
3. The bridge contract has set a wrong federation address.
   1. Use `bridge.changeFederation` function. This can be executed only by the owner which is the MultiSigWallet.

## How to test it manually
1. Connect to a web3 console. You can use truffle console running: `npx truffle console --network $networkname`.
2. Copy and paste each command in the web3 console.
   - For RSK network see `sovryn-token-bridge/bridge/scripts/test/rskTest.js`.
      - Take sell order
   - For Kovan network see `sovryn-token-bridge/bridge/scripts/test/ethTest.js`.
      - cross tokens with converter as receiver. So it creates a sell order in the RSk converter contract
      - cross tokens to another address
